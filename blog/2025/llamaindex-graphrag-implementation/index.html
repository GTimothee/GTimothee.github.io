<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> graphRAG implementation in Llama Index | Timothée Guédon </title> <meta name="author" content="Timothée Guédon"> <meta name="description" content="The goal is to understand the implementation of graphRAG by llamaindex."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website, timothee, guedon, ai, deep-learning, data-science, generative-ai"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%9A%80&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://gtimothee.github.io/blog/2025/llamaindex-graphrag-implementation/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Timothée</span> Guédon </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">graphRAG implementation in Llama Index</h1> <p class="post-meta"> Created in March 17, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/rag"> <i class="fa-solid fa-hashtag fa-sm"></i> rag</a>   ·   <a href="/blog/category/rag"> <i class="fa-solid fa-tag fa-sm"></i> rag</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>// in progress</p> <h2 id="clean-version">Clean version</h2> <p>Here is a graphRAG guide with llama index.</p> <h3 id="1-load-your-data">1. Load your data</h3> <p>ref: https://docs.llamaindex.ai/en/v0.10.19/module_guides/loading/node_parsers/modules.html</p> <ul> <li>Loading from files ? use FlatFileReader to load the files</li> <li>Loading from memory (.e.g. loading from a dataframe) ? go directly to step 2</li> </ul> <h3 id="2-initial-preprocessing">2. Initial preprocessing</h3> <h4 id="transformations">Transformations</h4> <p>Transformations take nodes as input and outputs nodes.</p> <p>It can be used to perform preprocessing like chunking or metadata extraction for example.</p> <h4 id="chunking">Chunking</h4> <p>Utilities for splitting are called splitters.</p> <p>ref: https://docs.llamaindex.ai/en/v0.10.19/module_guides/loading/node_parsers/modules.html</p> <ul> <li>Loading from files ? use SimpleFileNodeParser on the docs you retrieved with FlatFileReader. It will use the best splitter regarding the extension of the file you loaded.</li> <li>Loading from memory ? choose the best splitter depending on your data <ul> <li>simple text: TokenTextSplitter, SentenceSplitter (split on sentences, with overlap), SentenceWindowNodeParser (split on sentences, with sentence-level overlap put in metadata), MarkdownNodeParser, SemanticSplitterNodeParser (by Greg Kamradt, requires an embedding model)</li> <li>special format: JSONNodeParser, HTMLNodeParser, CodeSplitter</li> <li>meh: HierarchicalNodeParser (advanced)</li> </ul> </li> </ul> <h4 id="metadata-extraction">Metadata extraction</h4> <h4 id="defining-our-transformations">Defining our transformations</h4> <p>Define the transformations globally (through the Settings) or pass the transformations list in the constructor of the index.</p> <h3 id="3-initial-preprocessing">3. Initial preprocessing</h3> <hr> <h2 id="research-notes">Research notes</h2> <h3 id="high-level-result-of-investigation">High level result of investigation</h3> <ul> <li>Each chunk is a llama index Node</li> <li>For each chunk, we extract nodes and relationships and add them to the chunk (Node) metadata</li> <li>Extractors are documented here: https://docs.llamaindex.ai/en/stable/module_guides/indexing/lpg_index_guide/#default-simplellmpathextractor</li> <li>in LlamaIndex, we can combine several node retrieval methods at once <ul> <li>If no sub-retrievers are provided, the defaults are LLMSynonymRetriever and VectorContextRetriever (if embeddings are enabled)</li> </ul> </li> <li>default store (in memory ) does not support embeddings, you need to use one of Neo4jPropertyGraphStore, TiDBPropertyGraphStore, FalkorDBPropertyGraphStore</li> </ul> <p>base store: SimplePropertyGraphStore</p> <ul> <li>EntityNode, Relation are nodes and relationships extracted from chunk</li> <li>EntityNode are linked to their source chunk modeled as TextNode using Relation with label HAS_SOURCE</li> </ul> <p>interesting methods:</p> <ul> <li>graph_store.get_rel_map([entity_node], depth=2): gets triples up to a certain depth</li> <li>graph_store.get_llama_nodes([‘id1’]): gets the original text nodes</li> <li>graph_store.structured_query(“<cypher query="">") - runs a cypher query (assuming the graph store supports it)</cypher> </li> </ul> <p>overview of useful extractors:</p> <ul> <li>SimpleLLMPathExtractor: simple extractor of <code class="language-plaintext highlighter-rouge">subject,predicate,object</code> triples, with a max_paths_per_chunk argument</li> <li>DynamicLLMPathExtractor: like neo4j approach, using node types</li> </ul> <p>All retrievers currently include:</p> <ul> <li>LLMSynonymRetriever: retrieve based on LLM generated keywords/synonyms <ul> <li>a prompt to extract synonyms</li> <li>fetch matching kg nodes (not llama nodes) and apply get_rel_map on them (gets triples up to a certain depth) =&gt; get nodes and neighborhood in form of triplets, then convert triplets to NodeWithScore</li> </ul> </li> <li>VectorContextRetriever: retrieve based on embedded graph nodes</li> <li>TextToCypherRetriever: ask the LLM to generate cypher based on the schema of the property graph <ul> <li>NOTE: Since the SimplePropertyGraphStore is not actually a graph database, it does not support cypher queries.</li> </ul> </li> <li>CypherTemplateRetriever: use a cypher template with params inferred by the LLM <ul> <li>This is a more constrained version of the TextToCypherRetriever. Rather than letting the LLM have free-range of generating any cypher statement, we can instead provide a cypher template and have the LLM fill in the blanks.</li> </ul> </li> <li>CustomPGRetriever: easy to subclass and implement custom retrieval logic</li> </ul> <p>Define retrievers like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sub_retrievers = [
    VectorContextRetriever(index.property_graph_store, ...),
    LLMSynonymRetriever(index.property_graph_store, ...),
]

retriever = PGRetriever(sub_retrievers=sub_retrievers)
</code></pre></div></div> <p>Source: https://docs.llamaindex.ai/en/stable/module_guides/indexing/lpg_index_guide/</p> <h3 id="implementation-break-down-used-for-investigation">Implementation break down used for investigation</h3> <h4 id="graph-building-from-unstructured-text">graph building from unstructured text</h4> <ol> <li>docs = [Document(text=sample[‘text’]) for sample in docs]</li> <li>PropertyGraphIndex.from_documents</li> </ol> <h5 id="from_documents-inner-workings">“from_documents” inner workings:</h5> <ol> <li>Convert your docs to chunks (=Nodes) (See documentation on Documents and Nodes here https://docs.llamaindex.ai/en/stable/module_guides/loading/documents_and_nodes/#documents-nodes) using “transformations” (passed as argument or DEFAULTs TO Settings.transformations.</li> <li>create the instance form the nodes (means you could have parse your documents yourself and create the instance yourself with the constructor)</li> </ol> <h5 id="constructor-call">Constructor call</h5> <p>arguments:</p> <ul> <li>kg_extractors:A list of transformations to apply to the nodes to extract triplets. Defaults to [SimpleLLMPathExtractor(llm=llm), ImplicitEdgeExtractor()]</li> <li>default is to embed_kg_nodes (True)</li> <li>show_progress for progress bar</li> </ul> <p>build_index_from_nodes</p> <ul> <li>add nodes to docstore</li> <li>_build_index_from_nodes: an abstract class implemented in propertygraphindex</li> <li>returns index_struct</li> </ul> <h5 id="_build_index_from_nodes-implementation-in-propertygraphindex">_build_index_from_nodes implementation in propertygraphindex</h5> <p>when talking about “llama nodes” they talk about the TextNodes representing chunks</p> <p>self._insert_nodes(nodes or [])</p> <ul> <li>applies kg extractors on nodes</li> <li>builds two lists : one with all nodes and one with all relationships</li> <li>filters pure node duplciates between our list of all nodes and the list of nodes already in the store (filter applied on “node.id”)</li> <li>filter out duplicate llama nodes</li> <li>if _embed_kg_nodes: <ul> <li>embed nodes</li> <li>embed llama nodes</li> </ul> </li> <li>insert lalma nodes in property graph</li> <li>insert nodes in property graph</li> <li>insert relationships in property graphs</li> </ul> <p>llama nodes are ChunkNode(s) from Llama-index</p> <h4 id="querying">querying</h4> <ol> <li>create query engine from the index <ul> <li>possible response modes: https://docs.llamaindex.ai/en/stable/module_guides/deploying/query_engine/response_modes/</li> <li>if you want to tune it, construct it yourself instead of using the as_query_engine method as it lacks parameters</li> </ul> </li> <li>just call the query engine with the query</li> <li>creates a query bundle from the query (see below)</li> <li>calls the _query implementation of the query engine you chose</li> </ol> <p>Implementation of _query for the default RetrieverQueryEngine:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nodes = self.retrieve(query_bundle)
response = self._response_synthesizer.synthesize(
    query=query_bundle,
    nodes=nodes,
)
</code></pre></div></div> <p>The retriever just applies the retrievers that have been registered, and somehow (could not find where it is called but found the method) it also retrieves the source nodes (chunk nodes) for each triplet found. As a result you get the triplets found AND the source texts in your retrieved nodes. I do see it in my code, too.</p> <p>Query bundle: Can embed strings and images (give the image_path parameter)</p> <p>query_str (str): the original user-specified query string. This is currently used by all non embedding-based queries. custom_embedding_strs (list[str]): list of strings used for embedding the query. This is currently used by all embedding-based queries. embedding (list[float]): the stored embedding for the query.</p> <h4 id="implementation-tips">Implementation tips</h4> <ul> <li>use Settings to define llm and embedding project wide</li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/patterns-to-problems-thoughts/">Stop Learning Patterns, Start Solving Problems - Lessons from Biology and Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/embedding-model-fine-tuning/">Embedding model fine-tuning</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/homemade-keyword-retriever/">How to write your own keyword retriever in 5 minutes</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/simple-test-procedure-for-rag/">Test procedure and metrics for RAG in 5 minutes</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Timothée Guédon. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let theme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===theme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-projects",title:"Projects",description:"My last projects",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"post-graphrag-implementation-in-llama-index",title:"graphRAG implementation in Llama Index",description:"The goal is to understand the implementation of graphRAG by llamaindex.",section:"Posts",handler:()=>{window.location.href="/blog/2025/llamaindex-graphrag-implementation/"}},{id:"post-stop-learning-patterns-start-solving-problems-lessons-from-biology-and-engineering",title:"Stop Learning Patterns, Start Solving Problems - Lessons from Biology and Engineering",description:"This blog explores the shift from rigid categorization to creative problem-solving, drawing parallels between biology&#39;s evolution and modern engineering practices.",section:"Posts",handler:()=>{window.location.href="/blog/2025/patterns-to-problems-thoughts/"}},{id:"post-embedding-model-fine-tuning",title:"Embedding model fine-tuning",description:"Embedding model fine-tuning",section:"Posts",handler:()=>{window.location.href="/blog/2024/embedding-model-fine-tuning/"}},{id:"post-how-to-write-your-own-keyword-retriever-in-5-minutes",title:"How to write your own keyword retriever in 5 minutes",description:"Tutorial on how to write your own keyword retriever using the whoosh library",section:"Posts",handler:()=>{window.location.href="/blog/2024/homemade-keyword-retriever/"}},{id:"post-test-procedure-and-metrics-for-rag-in-5-minutes",title:"Test procedure and metrics for RAG in 5 minutes",description:"Simple test procedure and metrics for your RAG in 5 minutes",section:"Posts",handler:()=>{window.location.href="/blog/2024/simple-test-procedure-for-rag/"}},{id:"news-rag-agent-with-neo4j-tuto-update",title:"RAG agent with Neo4j tuto update",description:"",section:"News",handler:()=>{window.location.href="/news/2025-02-11-RAG-agent-with-Neo4j-tuto-update/"}},{id:"news-new-repo-on-rag-experiments",title:"New repo on RAG experiments",description:"",section:"News",handler:()=>{window.location.href="/news/2024-10-27-RAG-experiments-repo/"}},{id:"news-hello-world",title:"Hello world",description:"",section:"News",handler:()=>{window.location.href="/news/2024-06-12-Hello-world!/"}},{id:"projects-smolagent-custom-tools",title:"Smolagent custom tools",description:"Tools I built and shared with the community while building an agent with the smolagents library.",section:"Projects",handler:()=>{window.location.href="/projects/1_smolagents_tools_project/"}},{id:"projects-knowledge-graphs-project",title:"Knowledge graphs project",description:"Experimenting with knowledge graphs and RAG applications",section:"Projects",handler:()=>{window.location.href="/projects/2_knowledge_graphs_project/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%74%69%6D%6F%74%68%65%65.%67%75%65%64%6F%6E@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=qc6CJjYAAAAJ","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>